name: EKS WebApp Deployment

on:
  push:
    branches:
      - "main"
    paths:
      - "web/**"
      - "k8s/**"
      - "argocd/**"
      - ".github/workflows/**"
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  deploy-webapp:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-2
      EKS_CLUSTER_NAME: kafka-enterprise-orders-eks-cluster
      GHCR_REGISTRY: ghcr.io
      PROJECT_NAME: kafka-enterprise-orders

    steps:
      # --------------------------------------------------------------
      # CHECKOUT CODE
      # --------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------------
      # CONFIGURE AWS
      # --------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # --------------------------------------------------------------
      # LOGIN TO GHCR
      # --------------------------------------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------------------
      # BUILD + PUSH FRONTEND
      # --------------------------------------------------------------
      - name: Build & Push Web Frontend
        run: |
          IMAGE="${{ env.GHCR_REGISTRY }}/${{ github.actor }}/${{ env.PROJECT_NAME }}/web-frontend:latest"
          echo "Building Frontend: $IMAGE"
          docker build -t $IMAGE ./web/frontend
          docker push $IMAGE

      # --------------------------------------------------------------
      # BUILD + PUSH BACKEND
      # --------------------------------------------------------------
      - name: Build & Push Web Backend
        run: |
          IMAGE="${{ env.GHCR_REGISTRY }}/${{ github.actor }}/${{ env.PROJECT_NAME }}/web-backend:latest"
          echo "Building Backend: $IMAGE"
          docker build -t $IMAGE ./web/backend
          docker push $IMAGE

      # --------------------------------------------------------------
      # SETUP KUBECONFIG FOR EKS
      # --------------------------------------------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.EKS_CLUSTER_NAME }}"

      # --------------------------------------------------------------
      # APPLY ARGOCD APPLICATION MANIFEST
      # --------------------------------------------------------------
      - name: Deploy ArgoCD Application
        run: |
          kubectl apply -f argocd/webapp.yaml

